// ========================================
// ÂìàÂà©Ê≥¢ÁâπÈ≠îÊ≥ïÈòÖËØªÂô® - ÊúÄÁªà‰øÆÂ§çÁâà
// ========================================

class MagicReader {
    constructor() {
        this.data = null;
        this.audio = document.getElementById('audioPlayer');
        this.showTranslation = true;
        this.tooltip = null;
        this.isSeeking = false; // Èò≤Ê≠¢Ë∑≥ËΩ¨ÂÜ≤Á™Å
        this.init();
    }
    
    async init() {
        await this.loadData();
        this.createTooltip();
        this.renderUI();
        this.initAudio();
        this.bindEvents();
    }
    
    async loadData() {
        try {
            const response = await fetch('../data/chapter1.json');
            this.data = await response.json();
            console.log('‚úÖ Êï∞ÊçÆÂä†ËΩΩÊàêÂäü');
        } catch (error) {
            console.error('‚ùå Âä†ËΩΩÂ§±Ë¥•:', error);
        }
    }
    
    createTooltip() {
        this.tooltip = document.createElement('div');
        this.tooltip.className = 'magic-tooltip';
        this.tooltip.style.display = 'none';
        document.body.appendChild(this.tooltip);
    }
    
    renderUI() {
        this.renderParagraphs();
        this.renderVocabulary();
        this.renderPhrases();
        this.renderSentences();
    }
    
    renderParagraphs() {
        const container = document.getElementById('paragraphsContainer');
        container.innerHTML = '';
        
        this.data.paragraphs.forEach(para => {
            const div = document.createElement('div');
            div.className = 'paragraph';
            div.dataset.id = para.id;
            div.dataset.audioStart = para.audioStart || 0;
            
            const enDiv = document.createElement('div');
            enDiv.className = 'paragraph-en';
            enDiv.innerHTML = this.highlightText(para.en);
            
            const zhDiv = document.createElement('div');
            zhDiv.className = 'paragraph-zh';
            zhDiv.textContent = para.zh;
            if (!this.showTranslation) zhDiv.style.display = 'none';
            
            div.appendChild(enDiv);
            div.appendChild(zhDiv);
            container.appendChild(div);
        });
    }
    
    highlightText(text) {
        let result = text;
        const replacements = [];
        
        // Êî∂ÈõÜÊâÄÊúâÂåπÈÖçÈ°π
        const items = [];
        
        // Âè•Â≠ê
        this.data.sentences.forEach(sent => {
            const regex = new RegExp(this.escapeRegex(sent.en), 'gi');
            let match;
            while ((match = regex.exec(text)) !== null) {
                items.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    text: match[0],
                    type: 'sentence',
                    id: sent.id,
                    original: sent
                });
            }
        });
        
        // Áü≠ËØ≠
        this.data.phrases.forEach(phrase => {
            const regex = new RegExp(`\\b${this.escapeRegex(phrase.phrase)}\\b`, 'gi');
            let match;
            while ((match = regex.exec(text)) !== null) {
                items.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    text: match[0],
                    type: 'phrase',
                    id: phrase.id,
                    original: phrase
                });
            }
        });
        
        // ÂçïËØç
        this.data.vocabulary.forEach(vocab => {
            const regex = new RegExp(`\\b${this.escapeRegex(vocab.word)}\\b`, 'gi');
            let match;
            while ((match = regex.exec(text)) !== null) {
                items.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    text: match[0],
                    type: 'word',
                    id: vocab.id,
                    original: vocab
                });
            }
        });
        
        // ÊåâÈïøÂ∫¶ÊéíÂ∫è
        items.sort((a, b) => b.text.length - a.text.length);
        
        // ÂéªÈáç
        const validItems = [];
        for (const item of items) {
            const overlaps = validItems.some(v => 
                (item.start >= v.start && item.start < v.end) ||
                (item.end > v.start && item.end <= v.end) ||
                (item.start <= v.start && item.end >= v.end)
            );
            if (!overlaps) {
                validItems.push(item);
            }
        }
        
        // Êåâ‰ΩçÁΩÆÊéíÂ∫è
        validItems.sort((a, b) => a.start - b.start);
        
        // ÊûÑÂª∫HTML
        let offset = 0;
        let newHtml = '';
        
        validItems.forEach(item => {
            newHtml += text.substring(offset, item.start);
            
            const tooltip = this.getTooltipData(item);
            const tooltipStr = JSON.stringify(tooltip).replace(/'/g, "&apos;");
            newHtml += `<span class="highlight-${item.type}" data-type="${item.type}" data-id="${item.id}" data-tooltip='${tooltipStr}'>${item.text}</span>`;
            
            offset = item.end;
        });
        
        newHtml += text.substring(offset);
        return newHtml;
    }
    
    getTooltipData(item) {
        if (item.type === 'word') {
            const vocab = item.original;
            // ‰ºòÂÖà‰ΩøÁî®chineseÔºåÂ¶ÇÊûú‰∏∫Á©∫Âàô‰ªédefinition‰∏≠ÊèêÂèñÁ¨¨‰∏ÄÂè•ÔºàÊã¨Âè∑ÂâçÁöÑÂÜÖÂÆπÔºâ
            let chinese = vocab.chinese || '';
            if (!chinese || chinese.trim() === '') {
                const def = vocab.definition || '';
                // ÊèêÂèñÁ¨¨‰∏ÄÂè•ÊàñÊã¨Âè∑ÂâçÁöÑÂÜÖÂÆπ
                const match = def.match(/^([^(Ôºà]+)/);
                chinese = match ? match[1].trim() : def.substring(0, 20);
            }
            
            return {
                type: 'word',
                word: vocab.word || '',
                phonetic: vocab.phonetic || '',
                chinese: chinese
            };
        } else if (item.type === 'phrase') {
            return {
                type: 'phrase',
                phrase: item.original.phrase || '',
                chinese: item.original.chinese || ''
            };
        } else if (item.type === 'sentence') {
            return {
                type: 'sentence',
                zh: item.original.zh || ''
            };
        }
        return {};
    }
    
    escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    renderVocabulary() {
        const container = document.querySelector('#vocabularyTab .vocab-list');
        container.innerHTML = '';
        
        this.data.vocabulary.forEach(vocab => {
            const card = document.createElement('div');
            card.className = 'vocab-card';
            card.dataset.id = vocab.id;
            
            const wordHtml = vocab.phonetic 
                ? `${vocab.word}<span class="word-phonetic">${vocab.phonetic}</span>`
                : vocab.word;
            
            card.innerHTML = `
                <div class="word-title">${wordHtml}</div>
                <div class="word-pos">${vocab.pos || ''}</div>
                <div class="word-chinese">${vocab.chinese || ''}</div>
                <div class="word-def">${vocab.definition || ''}</div>
            `;
            container.appendChild(card);
        });
    }
    
    renderPhrases() {
        const container = document.querySelector('#phrasesTab .phrase-list');
        container.innerHTML = '';
        
        this.data.phrases.forEach(phrase => {
            const card = document.createElement('div');
            card.className = 'phrase-card';
            card.dataset.id = phrase.id;
            card.innerHTML = `
                <div class="phrase-title">${phrase.phrase}</div>
                <div class="phrase-chinese">${phrase.chinese || ''}</div>
                <div class="phrase-exp">${phrase.explanation || ''}</div>
            `;
            container.appendChild(card);
        });
    }
    
    renderSentences() {
        const container = document.querySelector('#sentencesTab .sentence-list');
        container.innerHTML = '';
        
        this.data.sentences.forEach(sent => {
            const card = document.createElement('div');
            card.className = 'sentence-card';
            card.dataset.id = sent.id;
            card.innerHTML = `
                <div class="sent-en">${sent.en}</div>
                <div class="sent-zh">${sent.zh || ''}</div>
                ${sent.explanation ? `<div class="sent-exp">${sent.explanation}</div>` : ''}
            `;
            container.appendChild(card);
        });
    }
    
    initAudio() {
        this.audio.src = '../raw/audio/chapter1.mp3';
        this.audio.preload = 'auto';
        
        this.audio.addEventListener('loadedmetadata', () => {
            document.getElementById('totalTime').textContent = this.formatTime(this.audio.duration);
            console.log('üéµ Èü≥È¢ëÂä†ËΩΩÂÆåÊàêÔºåÊó∂Èïø:', this.audio.duration);
        });
        
        // ‚ö†Ô∏è ÂÖ≥ÈîÆ‰øÆÊîπÔºötimeupdateÂÆåÂÖ®‰∏çÂπ≤È¢ÑcurrentTime
        this.audio.addEventListener('timeupdate', () => {
            if (!this.isSeeking) {
                const progress = (this.audio.currentTime / this.audio.duration) * 100;
                document.getElementById('progressBar').value = progress;
                document.getElementById('currentTime').textContent = this.formatTime(this.audio.currentTime);
            }
        });
        
        // üîç ÁõëÊéßÊâÄÊúâÂèØËÉΩÊîπÂèòcurrentTimeÁöÑ‰∫ã‰ª∂
        ['seeking', 'seeked', 'play', 'pause', 'loadeddata'].forEach(event => {
            this.audio.addEventListener(event, () => {
                console.log(`üì¢ [${event}] currentTime =`, this.audio.currentTime.toFixed(2));
            });
        });
    }
    
    bindEvents() {
        // ÁøªËØëÂàáÊç¢
        document.getElementById('toggleTranslation')?.addEventListener('click', () => {
            this.showTranslation = !this.showTranslation;
            document.querySelectorAll('.paragraph-zh').forEach(el => {
                el.style.display = this.showTranslation ? '' : 'none';
            });
        });
        
        // Ê†áÁ≠æÂàáÊç¢
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.switchTab(btn.dataset.tab);
            });
        });
        
        // ‚òÖ‚òÖ‚òÖ ÊÆµËêΩÁÇπÂáª - Èü≥È¢ëË∑≥ËΩ¨ ‚òÖ‚òÖ‚òÖ
        document.getElementById('paragraphsContainer').addEventListener('click', (e) => {
            if (e.target.closest('.highlight-word, .highlight-phrase, .highlight-sentence')) {
                return;
            }
            
            const para = e.target.closest('.paragraph');
            if (para) {
                const audioStart = parseFloat(para.dataset.audioStart);
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('ÔøΩ ÁÇπÂáªÊÆµËêΩID:', para.dataset.id);
                console.log('üìç ÁõÆÊ†áÊó∂Èó¥:', audioStart, 'Áßí');
                console.log('‚è±Ô∏è ÂΩìÂâçÊó∂Èó¥:', this.audio.currentTime.toFixed(2), 'Áßí');
                console.log('‚ñ∂Ô∏è Êí≠ÊîæÁä∂ÊÄÅ:', this.audio.paused ? 'ÊöÇÂÅú‰∏≠' : 'Êí≠Êîæ‰∏≠');
                
                if (!isNaN(audioStart) && audioStart >= 0) {
                    // üî• ÊúÄÁõ¥Êé•ÁöÑÊñπÊ≥ï
                    this.isSeeking = true;
                    
                    // 1. ÊöÇÂÅú
                    const wasPaused = this.audio.paused;
                    if (!wasPaused) {
                        this.audio.pause();
                        console.log('‚è∏Ô∏è Â∑≤ÊöÇÂÅúÈü≥È¢ë');
                    }
                    
                    // 2. Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥Á°Æ‰øùÊöÇÂÅúÁîüÊïà
                    setTimeout(() => {
                        console.log('‚è© ËÆæÁΩÆ currentTime =', audioStart);
                        console.log('üìä ËÆæÁΩÆÂâç currentTime =', this.audio.currentTime.toFixed(2));
                        
                        // 3. ËÆæÁΩÆÊó∂Èó¥
                        this.audio.currentTime = audioStart;
                        
                        console.log('üìä ËÆæÁΩÆÂêéÁ´ãÂç≥ËØªÂèñ currentTime =', this.audio.currentTime.toFixed(2));
                        
                        // 4. Á≠âÂæÖseeked‰∫ã‰ª∂
                        const onSeeked = () => {
                            console.log('‚úÖ SeekedÂÆåÊàêÔºÅ');
                            console.log('üìä ÊúÄÁªà currentTime =', this.audio.currentTime.toFixed(2));
                            console.log('üìè ‰∏éÁõÆÊ†áÂ∑ÆÂÄº =', Math.abs(this.audio.currentTime - audioStart).toFixed(2), 'Áßí');
                            
                            // 5. Êí≠Êîæ
                            this.audio.play()
                                .then(() => {
                                    console.log('‚ñ∂Ô∏è Êí≠ÊîæÊàêÂäüÔºÅ');
                                    document.getElementById('playPauseBtn').textContent = '‚è∏ ÊöÇÂÅú';
                                })
                                .catch(err => {
                                    console.error('‚ùå Êí≠ÊîæÂ§±Ë¥•:', err);
                                })
                                .finally(() => {
                                    this.isSeeking = false;
                                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
                                });
                        };
                        
                        this.audio.addEventListener('seeked', onSeeked, { once: true });
                        
                        // 6. Ë∂ÖÊó∂‰øùÊä§
                        setTimeout(() => {
                            if (this.isSeeking) {
                                console.warn('‚ö†Ô∏è Seeked‰∫ã‰ª∂Ë∂ÖÊó∂ÔºÅÂº∫Âà∂Êí≠Êîæ');
                                this.isSeeking = false;
                                this.audio.play();
                                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
                            }
                        }, 2000);
                        
                    }, 50); // Á≠âÂæÖ50msÁ°Æ‰øùÊöÇÂÅúÁîüÊïà
                    
                } else {
                    console.error('‚ùå Êó†ÊïàÁöÑaudioStart:', audioStart);
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
                }
            }
        });
        
        // È´ò‰∫ÆËØçÊÇ¨ÂÅú
        document.getElementById('paragraphsContainer').addEventListener('mouseover', (e) => {
            const highlight = e.target.closest('.highlight-word, .highlight-phrase, .highlight-sentence');
            if (highlight) {
                this.showTooltip(highlight, e);
            }
        });
        
        document.getElementById('paragraphsContainer').addEventListener('mouseout', (e) => {
            const highlight = e.target.closest('.highlight-word, .highlight-phrase, .highlight-sentence');
            if (highlight) {
                this.hideTooltip();
            }
        });
        
        document.getElementById('paragraphsContainer').addEventListener('mousemove', (e) => {
            if (this.tooltip.style.display === 'block') {
                this.updateTooltipPosition(e);
            }
        });
        
        // È´ò‰∫ÆËØçÁÇπÂáª
        document.getElementById('paragraphsContainer').addEventListener('click', (e) => {
            const highlight = e.target.closest('.highlight-word, .highlight-phrase, .highlight-sentence');
            if (highlight) {
                e.stopPropagation();
                const type = highlight.dataset.type;
                const id = highlight.dataset.id;
                this.jumpToDetail(type, id);
            }
        });
        
        // Èü≥È¢ëÊéßÂà∂
        document.getElementById('playPauseBtn')?.addEventListener('click', () => {
            if (this.audio.paused) {
                this.audio.play();
                document.getElementById('playPauseBtn').textContent = '‚è∏ ÊöÇÂÅú';
            } else {
                this.audio.pause();
                document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Êí≠Êîæ';
            }
        });
        
        document.getElementById('speedBtn')?.addEventListener('click', () => {
            const speeds = [1.0, 1.25, 1.5, 0.75];
            const currentIndex = speeds.indexOf(this.audio.playbackRate);
            const newSpeed = speeds[(currentIndex + 1) % speeds.length];
            this.audio.playbackRate = newSpeed;
            document.getElementById('speedBtn').textContent = `ÈÄüÂ∫¶: ${newSpeed}x`;
        });
        
        document.getElementById('progressBar')?.addEventListener('input', (e) => {
            const time = (e.target.value / 100) * this.audio.duration;
            this.audio.currentTime = time;
        });
    }
    
    showTooltip(element, event) {
        try {
            const data = JSON.parse(element.dataset.tooltip);
            
            let content = '';
            if (data.type === 'word') {
                const word = data.word || '?';
                const phonetic = data.phonetic ? `<div class="tooltip-phonetic">${data.phonetic}</div>` : '';
                const chinese = data.chinese || 'ÊöÇÊó†Èáä‰πâ';
                
                content = `
                    <div class="tooltip-word">${word}</div>
                    ${phonetic}
                    <div class="tooltip-chinese">${chinese}</div>
                `;
            } else if (data.type === 'phrase') {
                content = `
                    <div class="tooltip-phrase">${data.phrase || '?'}</div>
                    <div class="tooltip-chinese">${data.chinese || 'ÊöÇÊó†Èáä‰πâ'}</div>
                `;
            } else if (data.type === 'sentence') {
                content = `
                    <div class="tooltip-zh">${data.zh || 'ÊöÇÊó†ÁøªËØë'}</div>
                `;
            }
            
            this.tooltip.innerHTML = content;
            this.tooltip.className = `magic-tooltip tooltip-${data.type}`;
            this.tooltip.style.display = 'block';
            this.updateTooltipPosition(event);
        } catch (err) {
            console.error('‚ùå TooltipÈîôËØØ:', err);
        }
    }
    
    updateTooltipPosition(event) {
        this.tooltip.style.left = (event.pageX + 15) + 'px';
        this.tooltip.style.top = (event.pageY + 15) + 'px';
    }
    
    hideTooltip() {
        this.tooltip.style.display = 'none';
    }
    
    switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        const btn = document.querySelector(`[data-tab="${tabName}"]`);
        const content = document.getElementById(`${tabName}Tab`);
        
        if (btn) btn.classList.add('active');
        if (content) content.classList.add('active');
    }
    
    jumpToDetail(type, id) {
        let tabName = '';
        let selector = '';
        
        if (type === 'word') {
            tabName = 'vocabulary';
            selector = '#vocabularyTab .vocab-card';
        } else if (type === 'phrase') {
            tabName = 'phrases';
            selector = '#phrasesTab .phrase-card';
        } else if (type === 'sentence') {
            tabName = 'sentences';
            selector = '#sentencesTab .sentence-card';
        }
        
        this.switchTab(tabName);
        
        setTimeout(() => {
            const cards = document.querySelectorAll(selector);
            cards.forEach(card => {
                card.classList.remove('highlight-active');
                if (card.dataset.id == id) {
                    card.classList.add('highlight-active');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }, 150);
    }
    
    formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
}

// ÂêØÂä®
document.addEventListener('DOMContentLoaded', () => {
    new MagicReader();
    console.log('‚ö° È≠îÊ≥ïÈòÖËØªÂô®Â∑≤ÂêØÂä®ÔºÅ');
});
